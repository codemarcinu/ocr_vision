<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paragony - Second Brain</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5; color: #333; line-height: 1.5;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        header {
            background: #2c3e50; color: white; padding: 20px;
            margin-bottom: 20px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { font-size: 1.5rem; font-weight: 600; }
        header p { opacity: 0.8; font-size: 0.9rem; margin-top: 5px; }
        .header-nav { display: flex; gap: 10px; }
        .header-nav a {
            color: white; text-decoration: none; opacity: 0.7;
            font-size: 0.85rem; padding: 6px 12px; border-radius: 6px;
            background: rgba(255,255,255,0.1);
        }
        .header-nav a:hover { opacity: 1; background: rgba(255,255,255,0.2); }

        /* Filters */
        .filters {
            display: flex; gap: 15px; margin-bottom: 20px;
            flex-wrap: wrap; align-items: center;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-group label { font-size: 0.85rem; color: #666; }
        input[type="text"], input[type="date"], select {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem;
        }
        input:focus, select:focus { outline: none; border-color: #3498db; }

        /* Buttons */
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-link { background: none; color: #3498db; padding: 0; text-decoration: underline; }

        /* Receipt table */
        .receipt-table {
            width: 100%; border-collapse: collapse; background: white;
            border-radius: 8px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .receipt-table th {
            background: #ecf0f1; padding: 12px 15px; text-align: left;
            font-size: 0.85rem; color: #666; font-weight: 600;
        }
        .receipt-table td {
            padding: 12px 15px; border-top: 1px solid #eee; font-size: 0.9rem;
        }
        .receipt-table tr:hover td { background: #f9f9f9; }
        .receipt-table tr.clickable { cursor: pointer; }
        .receipt-total { font-weight: 600; color: #27ae60; }
        .receipt-review { color: #f39c12; font-weight: 600; }

        /* Pagination */
        .pagination {
            display: flex; justify-content: center; gap: 8px;
            margin-top: 20px; align-items: center;
        }
        .pagination button { min-width: 36px; }
        .pagination .page-info { font-size: 0.85rem; color: #7f8c8d; margin: 0 10px; }

        /* Detail view */
        .detail-panel {
            display: none; background: white; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px;
        }
        .detail-panel.visible { display: block; }
        .detail-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;
        }
        .detail-header h2 { font-size: 1.2rem; }
        .detail-meta { display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap; }
        .detail-meta .meta-item { font-size: 0.9rem; }
        .detail-meta .meta-label { color: #7f8c8d; }
        .detail-meta .meta-value { font-weight: 600; }

        /* Items table */
        .items-table { width: 100%; border-collapse: collapse; }
        .items-table th {
            background: #f9f9f9; padding: 8px 12px; text-align: left;
            font-size: 0.8rem; color: #666;
        }
        .items-table td { padding: 8px 12px; border-top: 1px solid #f0f0f0; font-size: 0.9rem; }
        .items-table tr:hover td { background: #f5f5f5; }

        .editable {
            cursor: pointer; border-bottom: 1px dashed #ccc;
            padding: 2px 4px; border-radius: 3px;
        }
        .editable:hover { background: #e8f4fd; }
        .edit-input {
            padding: 4px 8px; border: 1px solid #3498db; border-radius: 4px;
            font-size: 0.9rem; width: 100%;
        }
        .discount { color: #e74c3c; font-size: 0.8rem; }
        .warning-badge {
            background: #fff3cd; color: #856404; padding: 2px 6px;
            border-radius: 4px; font-size: 0.75rem;
        }

        /* Store emoji */
        .store-emoji { margin-right: 4px; }

        /* Messages */
        .message { padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }

        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .loading::after {
            content: ""; display: inline-block; width: 20px; height: 20px;
            border: 2px solid #ddd; border-top-color: #3498db; border-radius: 50%;
            animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 40px; color: #7f8c8d; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Paragony</h1>
                <p>Przegladanie i edycja paragonow</p>
            </div>
            <div class="header-nav">
                <a href="/web/dictionary">Slownik</a>
                <a href="/web/pantry">Spizarnia</a>
                <a href="/web/search">Szukaj</a>
            </div>
        </header>

        <div id="message" class="message"></div>

        <!-- Detail panel (shown when clicking a receipt) -->
        <div id="detail-panel" class="detail-panel">
            <div class="detail-header">
                <h2 id="detail-title">Paragon</h2>
                <button class="btn btn-secondary btn-sm" onclick="closeDetail()">Zamknij</button>
            </div>
            <div class="detail-meta" id="detail-meta"></div>
            <table class="items-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nazwa (OCR)</th>
                        <th>Nazwa znormalizowana</th>
                        <th>Cena</th>
                        <th>Rabat</th>
                        <th>Kategoria</th>
                        <th>Akcje</th>
                    </tr>
                </thead>
                <tbody id="detail-items"></tbody>
            </table>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <label>Sklep:</label>
                <select id="filter-store"><option value="">Wszystkie</option></select>
            </div>
            <div class="filter-group">
                <label>Od:</label>
                <input type="date" id="filter-from">
            </div>
            <div class="filter-group">
                <label>Do:</label>
                <input type="date" id="filter-to">
            </div>
            <button class="btn btn-primary" onclick="loadReceipts()">Filtruj</button>
            <button class="btn btn-secondary" onclick="clearFilters()">Wyczysc</button>
        </div>

        <!-- Receipts list -->
        <div id="receipts-container">
            <table class="receipt-table">
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Sklep</th>
                        <th>Suma</th>
                        <th>Status</th>
                        <th>Plik</th>
                    </tr>
                </thead>
                <tbody id="receipts-list">
                    <tr><td colspan="5"><div class="loading">Ladowanie...</div></td></tr>
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination"></div>
    </div>

    <script>
        const API = '';
        let currentPage = 0;
        let pageSize = 20;
        let totalReceipts = 0;
        let stores = [];
        let currentReceiptId = null;
        let categoriesMap = {};

        const STORE_EMOJI = {
            'biedronka': '&#128030;', 'lidl': '&#128309;', 'kaufland': '&#128308;',
            'zabka': '&#128056;', 'Å¼abka': '&#128056;', 'auchan': '&#128994;',
            'carrefour': '&#128311;', 'netto': '&#128993;', 'dino': '&#129430;',
            'rossmann': '&#128132;', 'hebe': '&#128133;',
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadStores(), loadCategories()]);
            await loadReceipts();
        });

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text; msg.className = `message ${type}`;
            setTimeout(() => msg.className = 'message', 5000);
        }

        function getStoreEmoji(storeName) {
            if (!storeName) return '';
            const key = storeName.toLowerCase().split(',')[0].split(' ')[0];
            return STORE_EMOJI[key] || '';
        }

        async function loadStores() {
            try {
                const res = await fetch(`${API}/dictionary/stores`);
                stores = await res.json();
                const select = document.getElementById('filter-store');
                stores.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.id || s.normalized_name;
                    opt.textContent = s.normalized_name;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Stores error:', e); }
        }

        async function loadCategories() {
            try {
                const res = await fetch(`${API}/dictionary/categories`);
                const data = await res.json();
                data.forEach(c => { categoriesMap[c.id] = c.key; });
            } catch (e) { console.error('Categories error:', e); }
        }

        async function loadReceipts() {
            const tbody = document.getElementById('receipts-list');
            tbody.innerHTML = '<tr><td colspan="5"><div class="loading">Ladowanie...</div></td></tr>';

            const storeId = document.getElementById('filter-store').value;
            const dateFrom = document.getElementById('filter-from').value;
            const dateTo = document.getElementById('filter-to').value;

            let url = `${API}/receipts?limit=${pageSize}&offset=${currentPage * pageSize}`;
            if (storeId) url += `&store_id=${storeId}`;
            if (dateFrom) url += `&date_from=${dateFrom}`;
            if (dateTo) url += `&date_to=${dateTo}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                totalReceipts = data.total;
                renderReceipts(data.items);
                renderPagination();
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="5"><div class="empty-state">Blad: ${e.message}</div></td></tr>`;
            }
        }

        function renderReceipts(receipts) {
            const tbody = document.getElementById('receipts-list');

            if (!receipts.length) {
                tbody.innerHTML = '<tr><td colspan="5"><div class="empty-state">Brak paragonow</div></td></tr>';
                return;
            }

            tbody.innerHTML = receipts.map(r => {
                const emoji = getStoreEmoji(r.store);
                const total = r.total_final ? r.total_final.toFixed(2) + ' zl' : '-';
                const status = r.needs_review
                    ? '<span class="receipt-review">&#9888; Do weryfikacji</span>'
                    : '&#10003;';

                return `
                    <tr class="clickable" onclick="openDetail('${r.id}')">
                        <td>${r.receipt_date || '-'}</td>
                        <td><span class="store-emoji">${emoji}</span>${escapeHtml(r.store || 'nieznany')}</td>
                        <td class="receipt-total">${total}</td>
                        <td>${status}</td>
                        <td style="font-size:0.8rem; color:#7f8c8d">${escapeHtml(r.source_file || '')}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderPagination() {
            const totalPages = Math.ceil(totalReceipts / pageSize);
            const pag = document.getElementById('pagination');

            if (totalPages <= 1) { pag.innerHTML = ''; return; }

            let html = '';
            html += `<button class="btn btn-secondary btn-sm" ${currentPage === 0 ? 'disabled' : ''} onclick="goPage(${currentPage - 1})">&#8592;</button>`;
            html += `<span class="page-info">${currentPage + 1} / ${totalPages} (${totalReceipts} paragonow)</span>`;
            html += `<button class="btn btn-secondary btn-sm" ${currentPage >= totalPages - 1 ? 'disabled' : ''} onclick="goPage(${currentPage + 1})">&#8594;</button>`;

            pag.innerHTML = html;
        }

        function goPage(page) {
            currentPage = page;
            loadReceipts();
        }

        function clearFilters() {
            document.getElementById('filter-store').value = '';
            document.getElementById('filter-from').value = '';
            document.getElementById('filter-to').value = '';
            currentPage = 0;
            loadReceipts();
        }

        // Detail view
        async function openDetail(receiptId) {
            currentReceiptId = receiptId;
            const panel = document.getElementById('detail-panel');
            panel.classList.add('visible');

            try {
                const res = await fetch(`${API}/receipts/${receiptId}`);
                if (!res.ok) throw new Error('Not found');
                const r = await res.json();

                const emoji = getStoreEmoji(r.store);
                document.getElementById('detail-title').innerHTML =
                    `<span class="store-emoji">${emoji}</span>${escapeHtml(r.store || 'Paragon')} - ${r.receipt_date || ''}`;

                document.getElementById('detail-meta').innerHTML = `
                    <div class="meta-item"><span class="meta-label">Suma OCR:</span> <span class="meta-value">${r.total_ocr ? r.total_ocr.toFixed(2) + ' zl' : '-'}</span></div>
                    <div class="meta-item"><span class="meta-label">Suma obliczona:</span> <span class="meta-value">${r.total_calculated ? r.total_calculated.toFixed(2) + ' zl' : '-'}</span></div>
                    <div class="meta-item"><span class="meta-label">Suma finalna:</span> <span class="meta-value">${r.total_final ? r.total_final.toFixed(2) + ' zl' : '-'}</span></div>
                    <div class="meta-item"><span class="meta-label">Plik:</span> <span class="meta-value">${escapeHtml(r.source_file || '')}</span></div>
                    ${r.needs_review ? '<div class="meta-item"><span class="receipt-review">&#9888; ' + (r.review_reasons || []).join(', ') + '</span></div>' : ''}
                `;

                renderDetailItems(r.items, receiptId);
                panel.scrollIntoView({ behavior: 'smooth' });
            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        function renderDetailItems(items, receiptId) {
            const tbody = document.getElementById('detail-items');

            if (!items || !items.length) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state">Brak produktow</div></td></tr>';
                return;
            }

            tbody.innerHTML = items.map((item, i) => {
                const discount = item.discount_amount
                    ? `<span class="discount">-${item.discount_amount.toFixed(2)} zl</span>`
                    : '';
                const warning = item.warning
                    ? `<span class="warning-badge">${escapeHtml(item.warning)}</span>`
                    : '';

                return `
                    <tr id="item-row-${item.id}">
                        <td>${i + 1}</td>
                        <td>
                            <span class="editable" onclick="editField(this, '${receiptId}', ${item.id}, 'name_raw')">${escapeHtml(item.name_raw)}</span>
                            ${warning}
                        </td>
                        <td>
                            <span class="editable" onclick="editField(this, '${receiptId}', ${item.id}, 'name_normalized')">${escapeHtml(item.name_normalized || '-')}</span>
                        </td>
                        <td>
                            <span class="editable" onclick="editField(this, '${receiptId}', ${item.id}, 'price_final')">${item.price_final.toFixed(2)} zl</span>
                            ${item.price_original ? '<br><small style="color:#7f8c8d">Przed: ' + item.price_original.toFixed(2) + ' zl</small>' : ''}
                        </td>
                        <td>${discount}</td>
                        <td>${escapeHtml(item.category || '-')}</td>
                        <td><span style="font-size:0.75rem; color:#7f8c8d">${item.match_method || ''}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function editField(el, receiptId, itemId, field) {
            const currentValue = el.textContent.replace(' zl', '').trim();
            if (currentValue === '-') {
                el.innerHTML = `<input class="edit-input" type="text" value="" onblur="saveField(this, '${receiptId}', ${itemId}, '${field}')" onkeydown="if(event.key==='Enter')this.blur()">`;
            } else {
                el.innerHTML = `<input class="edit-input" type="text" value="${escapeHtml(currentValue)}" onblur="saveField(this, '${receiptId}', ${itemId}, '${field}')" onkeydown="if(event.key==='Enter')this.blur()">`;
            }
            el.querySelector('input').focus();
        }

        async function saveField(input, receiptId, itemId, field) {
            const value = input.value.trim();
            const parent = input.parentElement;

            if (!value) {
                parent.textContent = '-';
                parent.classList.add('editable');
                return;
            }

            const body = {};
            if (field === 'price_final') {
                const num = parseFloat(value.replace(',', '.'));
                if (isNaN(num)) { parent.textContent = value; return; }
                body.price_final = num;
            } else {
                body[field] = value;
            }

            try {
                const res = await fetch(`${API}/receipts/${receiptId}/items/${itemId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });

                if (!res.ok) throw new Error('Update failed');

                if (field === 'price_final') {
                    parent.textContent = parseFloat(value.replace(',', '.')).toFixed(2) + ' zl';
                } else {
                    parent.textContent = value;
                }
                parent.classList.add('editable');
                showMessage('Zapisano', 'success');
            } catch (e) {
                parent.textContent = value;
                parent.classList.add('editable');
                showMessage(`Blad zapisu: ${e.message}`, 'error');
            }
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.remove('visible');
            currentReceiptId = null;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
    </script>
</body>
</html>
