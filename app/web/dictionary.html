<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slownik produktow - Smart Pantry</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        header p {
            opacity: 0.8;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            background: #ddd;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 0.95rem;
            transition: background 0.2s;
        }

        .tab:hover {
            background: #ccc;
        }

        .tab.active {
            background: white;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 8px 8px 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-size: 0.85rem;
            color: #666;
        }

        input[type="text"], select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        input[type="text"]:focus, select:focus {
            outline: none;
            border-color: #3498db;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Product list */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .product-item {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
        }

        .product-item.mapped {
            background: #e8f5e9;
            border-color: #c8e6c9;
        }

        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .product-name {
            font-family: monospace;
            font-size: 1rem;
            font-weight: 600;
            color: #2c3e50;
            word-break: break-all;
        }

        .product-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: #666;
        }

        .product-count {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .product-price {
            color: #27ae60;
            font-weight: 500;
        }

        .product-store {
            color: #7f8c8d;
        }

        .product-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .product-form input[type="text"] {
            flex: 1;
            min-width: 150px;
        }

        .product-form select {
            min-width: 140px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dictionary tab */
        .category-section {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #ecf0f1;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .category-header:hover {
            background: #dfe6e9;
        }

        .category-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .category-count {
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        .category-products {
            padding-left: 20px;
            display: none;
        }

        .category-products.expanded {
            display: block;
        }

        .dict-product {
            padding: 10px;
            border-left: 3px solid #3498db;
            margin-bottom: 10px;
            background: #f9f9f9;
        }

        .dict-product-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .dict-variants {
            font-size: 0.85rem;
            color: #666;
        }

        .dict-variant {
            display: inline-block;
            background: #eee;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 2px;
            font-family: monospace;
            font-size: 0.8rem;
        }

        /* Shortcuts tab */
        .shortcut-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 15px;
            background: #f9f9f9;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .shortcut-key {
            font-family: monospace;
            font-weight: 600;
            background: #2c3e50;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            min-width: 120px;
            text-align: center;
        }

        .shortcut-arrow {
            color: #7f8c8d;
        }

        .shortcut-value {
            flex: 1;
        }

        .add-form {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 8px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .add-form input[type="text"] {
            flex: 1;
            min-width: 150px;
        }

        /* Messages */
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-top-color: #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Stats bar */
        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Slownik produktow</h1>
            <p>Zarzadzanie normalizacja nazw produktow z paragonow</p>
        </header>

        <div id="message" class="message"></div>

        <div class="tabs">
            <button class="tab active" data-tab="unmatched">Nierozpoznane (<span id="unmatched-count">0</span>)</button>
            <button class="tab" data-tab="dictionary">Slownik</button>
            <button class="tab" data-tab="shortcuts">Skroty</button>
        </div>

        <!-- Tab 1: Unmatched products -->
        <div id="tab-unmatched" class="tab-content active">
            <div class="filters">
                <div class="filter-group">
                    <label>Szukaj:</label>
                    <input type="text" id="unmatched-search" placeholder="nazwa produktu...">
                </div>
                <div class="filter-group">
                    <label>Sklep:</label>
                    <select id="unmatched-store">
                        <option value="">Wszystkie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>
                        <input type="checkbox" id="unmatched-min-count" checked>
                        Min. 2 wystapienia
                    </label>
                </div>
                <button class="btn btn-secondary" onclick="loadUnmatched()">Odswiez</button>
            </div>

            <div id="unmatched-list" class="product-list">
                <div class="loading">Ladowanie...</div>
            </div>
        </div>

        <!-- Tab 2: Dictionary -->
        <div id="tab-dictionary" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <label>Kategoria:</label>
                    <select id="dict-category">
                        <option value="">Wszystkie</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Szukaj:</label>
                    <input type="text" id="dict-search" placeholder="nazwa produktu...">
                </div>
                <button class="btn btn-secondary" onclick="loadDictionary()">Odswiez</button>
            </div>

            <div id="dictionary-list">
                <div class="loading">Ladowanie...</div>
            </div>
        </div>

        <!-- Tab 3: Shortcuts -->
        <div id="tab-shortcuts" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <label>Sklep:</label>
                    <select id="shortcuts-store">
                        <option value="biedronka">Biedronka</option>
                        <option value="lidl">Lidl</option>
                        <option value="kaufland">Kaufland</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Szukaj:</label>
                    <input type="text" id="shortcuts-search" placeholder="skrot lub nazwa...">
                </div>
                <button class="btn btn-secondary" onclick="loadShortcuts()">Odswiez</button>
            </div>

            <div id="shortcuts-list">
                <div class="loading">Ladowanie...</div>
            </div>

            <div class="add-form">
                <input type="text" id="new-shortcut-key" placeholder="Skrot (np. mroznkr)">
                <input type="text" id="new-shortcut-value" placeholder="Pelna nazwa (np. mrozonka krakowska)">
                <button class="btn btn-success" onclick="addShortcut()">+ Dodaj skrot</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let categories = [];
        let stores = [];
        let unmatchedData = [];

        // API base
        const API = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Load initial data
            await loadCategories();
            await loadStores();
            await loadUnmatched();

            // Filter event listeners
            document.getElementById('unmatched-search').addEventListener('input', debounce(filterUnmatched, 300));
            document.getElementById('unmatched-store').addEventListener('change', filterUnmatched);
            document.getElementById('unmatched-min-count').addEventListener('change', filterUnmatched);
            document.getElementById('dict-search').addEventListener('input', debounce(loadDictionary, 300));
            document.getElementById('dict-category').addEventListener('change', loadDictionary);
            document.getElementById('shortcuts-store').addEventListener('change', loadShortcuts);
            document.getElementById('shortcuts-search').addEventListener('input', debounce(filterShortcuts, 300));
        });

        // Utility functions
        function debounce(fn, delay) {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn(...args), delay);
            };
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            setTimeout(() => msg.className = 'message', 5000);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Load data for tab
            if (tabId === 'dictionary') loadDictionary();
            if (tabId === 'shortcuts') loadShortcuts();
        }

        // Load categories for dropdowns
        async function loadCategories() {
            try {
                const res = await fetch(`${API}/dictionary/categories`);
                const data = await res.json();
                // API returns [{key, id, description, products_count}, ...]
                categories = data.map(c => c.key);

                const select = document.getElementById('dict-category');
                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.key;
                    opt.textContent = `${cat.key} (${cat.products_count})`;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load categories:', e);
            }
        }

        // Load stores for dropdowns
        async function loadStores() {
            try {
                const res = await fetch(`${API}/dictionary/stores`);
                const data = await res.json();
                // API returns [{normalized_name, aliases}, ...]
                stores = data.map(s => s.normalized_name);

                const select = document.getElementById('unmatched-store');
                stores.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store.toLowerCase();
                    opt.textContent = store;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load stores:', e);
            }
        }

        // === UNMATCHED TAB ===
        async function loadUnmatched() {
            const list = document.getElementById('unmatched-list');
            list.innerHTML = '<div class="loading">Ladowanie...</div>';

            try {
                const res = await fetch(`${API}/dictionary/unmatched`);
                unmatchedData = await res.json();
                document.getElementById('unmatched-count').textContent = unmatchedData.length;
                filterUnmatched();
            } catch (e) {
                list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">!</div>Blad ladowania: ${e.message}</div>`;
            }
        }

        function filterUnmatched() {
            const search = document.getElementById('unmatched-search').value.toLowerCase();
            const store = document.getElementById('unmatched-store').value.toLowerCase();
            const minCount = document.getElementById('unmatched-min-count').checked ? 2 : 1;

            const filtered = unmatchedData.filter(p => {
                if (search && !p.raw_name.toLowerCase().includes(search)) return false;
                if (store && (p.store || '').toLowerCase() !== store) return false;
                if (p.count < minCount) return false;
                return true;
            });

            renderUnmatched(filtered);
        }

        function renderUnmatched(products) {
            const list = document.getElementById('unmatched-list');

            if (!products.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#10003;</div>Brak nierozpoznanych produktow</div>';
                return;
            }

            list.innerHTML = products.map(p => `
                <div class="product-item" id="unmatched-${encodeId(p.raw_name)}">
                    <div class="product-header">
                        <div class="product-name">${escapeHtml(p.raw_name)}</div>
                        <div class="product-meta">
                            <span class="product-count">${p.count}x</span>
                            <span class="product-price">${p.price ? p.price.toFixed(2) + ' zl' : ''}</span>
                            <span class="product-store">${escapeHtml(p.store || '')}</span>
                        </div>
                    </div>
                    <div class="product-form">
                        <input type="text" id="norm-${encodeId(p.raw_name)}" placeholder="Znormalizowana nazwa..."
                               value="${suggestName(p.raw_name)}">
                        <select id="cat-${encodeId(p.raw_name)}">
                            <option value="">-- Kategoria --</option>
                            ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                        <button class="btn btn-success" onclick="learnProduct('${escapeJs(p.raw_name)}')">Zapisz</button>
                        <button class="btn btn-secondary" onclick="skipProduct('${escapeJs(p.raw_name)}')">Pomin</button>
                    </div>
                </div>
            `).join('');
        }

        function suggestName(rawName) {
            // Simple suggestion: lowercase, remove numbers and special chars
            return rawName
                .toLowerCase()
                .replace(/\d+[.,]?\d*\s*(g|kg|ml|l|szt)?\b/gi, '')
                .replace(/[^a-ząćęłńóśźż\s]/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        async function learnProduct(rawName) {
            const id = encodeId(rawName);
            const normalized = document.getElementById(`norm-${id}`).value.trim();
            const category = document.getElementById(`cat-${id}`).value;

            if (!normalized) {
                showMessage('Podaj znormalizowana nazwe', 'error');
                return;
            }
            if (!category) {
                showMessage('Wybierz kategorie', 'error');
                return;
            }

            try {
                const res = await fetch(`${API}/dictionary/learn/${encodeURIComponent(rawName)}?normalized_name=${encodeURIComponent(normalized)}&category=${encodeURIComponent(category)}`, {
                    method: 'POST'
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Unknown error');
                }

                // Mark as mapped
                document.getElementById(`unmatched-${id}`).classList.add('mapped');
                showMessage(`Zapisano: "${rawName}" -> "${normalized}"`, 'success');

                // Update count
                unmatchedData = unmatchedData.filter(p => p.raw_name !== rawName);
                document.getElementById('unmatched-count').textContent = unmatchedData.length;

            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        function skipProduct(rawName) {
            const id = encodeId(rawName);
            document.getElementById(`unmatched-${id}`).style.display = 'none';
        }

        // === DICTIONARY TAB ===
        async function loadDictionary() {
            const list = document.getElementById('dictionary-list');
            list.innerHTML = '<div class="loading">Ladowanie...</div>';

            const category = document.getElementById('dict-category').value;
            const search = document.getElementById('dict-search').value;

            try {
                let url = `${API}/dictionary/products?`;
                if (category) url += `category=${encodeURIComponent(category)}&`;
                if (search) url += `search=${encodeURIComponent(search)}&`;

                const res = await fetch(url);
                const data = await res.json();
                // API returns list directly: [{normalized_name, category, raw_names, typical_price}, ...]
                renderDictionary(data);
            } catch (e) {
                list.innerHTML = `<div class="empty-state">Blad ladowania: ${e.message}</div>`;
            }
        }

        function renderDictionary(products) {
            const list = document.getElementById('dictionary-list');

            if (!products || !products.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128218;</div>Brak produktow</div>';
                return;
            }

            // Group by category
            const byCategory = {};
            products.forEach(p => {
                const cat = p.category || 'inne';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(p);
            });

            list.innerHTML = Object.entries(byCategory).map(([cat, prods]) => `
                <div class="category-section">
                    <div class="category-header" onclick="toggleCategory('${cat}')">
                        <span class="category-name">${cat}</span>
                        <span class="category-count">${prods.length} produktow</span>
                    </div>
                    <div class="category-products" id="cat-products-${cat}">
                        ${prods.map(p => `
                            <div class="dict-product">
                                <div class="dict-product-name">${escapeHtml(p.normalized_name)}</div>
                                <div class="dict-variants">
                                    ${(p.raw_names || []).map(r => `<span class="dict-variant">${escapeHtml(r)}</span>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleCategory(cat) {
            const el = document.getElementById(`cat-products-${cat}`);
            el.classList.toggle('expanded');
        }

        // === SHORTCUTS TAB ===
        let shortcutsData = [];

        async function loadShortcuts() {
            const list = document.getElementById('shortcuts-list');
            list.innerHTML = '<div class="loading">Ladowanie...</div>';

            const store = document.getElementById('shortcuts-store').value;

            try {
                const res = await fetch(`${API}/dictionary/shortcuts?store=${store}`);
                // API returns [{shortcut, full_name, store}, ...]
                shortcutsData = await res.json();
                filterShortcuts();
            } catch (e) {
                list.innerHTML = `<div class="empty-state">Blad ladowania: ${e.message}</div>`;
            }
        }

        function filterShortcuts() {
            const search = document.getElementById('shortcuts-search').value.toLowerCase();

            const filtered = shortcutsData.filter(s => {
                if (search && !s.shortcut.toLowerCase().includes(search) && !s.full_name.toLowerCase().includes(search)) {
                    return false;
                }
                return true;
            });

            renderShortcuts(filtered);
        }

        function renderShortcuts(shortcuts) {
            const list = document.getElementById('shortcuts-list');

            if (!shortcuts.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128279;</div>Brak skrotow dla tego sklepu</div>';
                return;
            }

            list.innerHTML = shortcuts.map(s => `
                <div class="shortcut-item">
                    <span class="shortcut-key">${escapeHtml(s.shortcut)}</span>
                    <span class="shortcut-arrow">&#8594;</span>
                    <span class="shortcut-value">${escapeHtml(s.full_name)}</span>
                    <button class="btn btn-danger" onclick="deleteShortcut('${s.store}', '${escapeJs(s.shortcut)}')" title="Usun">&#10005;</button>
                </div>
            `).join('');
        }

        async function addShortcut() {
            const store = document.getElementById('shortcuts-store').value;
            const key = document.getElementById('new-shortcut-key').value.trim();
            const value = document.getElementById('new-shortcut-value').value.trim();

            if (!key || !value) {
                showMessage('Podaj skrot i pelna nazwe', 'error');
                return;
            }

            try {
                const res = await fetch(`${API}/dictionary/shortcuts/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ shortcut: key, full_name: value, store })
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Unknown error');
                }

                document.getElementById('new-shortcut-key').value = '';
                document.getElementById('new-shortcut-value').value = '';
                showMessage(`Dodano skrot: ${key} -> ${value}`, 'success');
                loadShortcuts();

            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        async function deleteShortcut(store, key) {
            if (!confirm(`Usunac skrot "${key}"?`)) return;

            try {
                const res = await fetch(`${API}/dictionary/shortcuts/${store}/${encodeURIComponent(key)}`, {
                    method: 'DELETE'
                });

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Unknown error');
                }

                showMessage(`Usunieto skrot: ${key}`, 'success');
                loadShortcuts();

            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        // Helpers
        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        function escapeJs(str) {
            return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
        }

        function encodeId(str) {
            return btoa(encodeURIComponent(str)).replace(/[+/=]/g, '_');
        }
    </script>
</body>
</html>
