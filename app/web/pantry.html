<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spizarnia - Second Brain</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5; color: #333; line-height: 1.5;
        }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        header {
            background: #2c3e50; color: white; padding: 20px;
            margin-bottom: 20px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { font-size: 1.5rem; font-weight: 600; }
        header p { opacity: 0.8; font-size: 0.9rem; margin-top: 5px; }
        .header-nav { display: flex; gap: 10px; }
        .header-nav a {
            color: white; text-decoration: none; opacity: 0.7;
            font-size: 0.85rem; padding: 6px 12px; border-radius: 6px;
            background: rgba(255,255,255,0.1);
        }
        .header-nav a:hover { opacity: 1; background: rgba(255,255,255,0.2); }

        /* Stats bar */
        .stats-bar {
            display: flex; gap: 20px; padding: 15px;
            background: #ecf0f1; border-radius: 8px; margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .stat { text-align: center; min-width: 80px; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: #2c3e50; }
        .stat-label { font-size: 0.8rem; color: #7f8c8d; }

        /* Toolbar */
        .toolbar {
            display: flex; gap: 15px; margin-bottom: 20px;
            flex-wrap: wrap; align-items: center;
        }
        .toolbar input[type="text"] {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 0.9rem; flex: 1; min-width: 200px;
        }
        .toolbar input[type="text"]:focus { outline: none; border-color: #3498db; }

        .batch-actions {
            display: flex; gap: 8px; align-items: center;
        }
        .batch-count {
            font-size: 0.85rem; color: #7f8c8d; min-width: 100px;
        }

        /* Buttons */
        .btn {
            padding: 8px 16px; border: none; border-radius: 6px;
            cursor: pointer; font-size: 0.9rem; transition: all 0.2s;
        }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-secondary:hover { background: #7f8c8d; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }

        /* Category sections */
        .category-section { margin-bottom: 15px; }
        .category-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #ecf0f1; border-radius: 6px;
            cursor: pointer; margin-bottom: 5px; user-select: none;
        }
        .category-header:hover { background: #dfe6e9; }
        .category-name { font-weight: 600; font-size: 1rem; }
        .category-count {
            background: #3498db; color: white; padding: 2px 10px;
            border-radius: 12px; font-size: 0.8rem; font-weight: 600;
        }
        .category-items { display: none; padding: 5px 0; }
        .category-items.expanded { display: block; }

        /* Item row */
        .item-row {
            display: flex; align-items: center; gap: 12px;
            padding: 10px 15px; background: white; border: 1px solid #eee;
            border-radius: 6px; margin-bottom: 4px; transition: background 0.2s;
        }
        .item-row:hover { background: #f9f9f9; }
        .item-row.old { border-left: 3px solid #f39c12; }
        .item-row.consumed { opacity: 0.5; text-decoration: line-through; }

        .item-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .item-name { flex: 1; font-weight: 500; }
        .item-store { color: #7f8c8d; font-size: 0.85rem; min-width: 100px; }
        .item-date { color: #7f8c8d; font-size: 0.85rem; min-width: 90px; }
        .item-qty { color: #3498db; font-size: 0.85rem; min-width: 40px; text-align: center; }
        .item-actions { display: flex; gap: 4px; }

        /* Add form */
        .add-form {
            display: none; padding: 15px; background: #ecf0f1;
            border-radius: 8px; margin-bottom: 20px;
        }
        .add-form.visible { display: block; }
        .add-form h3 { margin-bottom: 10px; font-size: 1rem; }
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-row input, .form-row select {
            padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 0.9rem; flex: 1; min-width: 150px;
        }
        .form-row input:focus, .form-row select:focus { outline: none; border-color: #3498db; }

        /* Messages */
        .message {
            padding: 12px 15px; border-radius: 6px; margin-bottom: 15px; display: none;
        }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; display: block; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; display: block; }

        /* Loading */
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .loading::after {
            content: ""; display: inline-block; width: 20px; height: 20px;
            border: 2px solid #ddd; border-top-color: #3498db; border-radius: 50%;
            animation: spin 1s linear infinite; margin-left: 10px; vertical-align: middle;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state { text-align: center; padding: 40px; color: #7f8c8d; }
        .empty-state-icon { font-size: 3rem; margin-bottom: 10px; }

        /* Category icons */
        .cat-icon { margin-right: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>Spizarnia</h1>
                <p>Zarzadzanie produktami w domu</p>
            </div>
            <div class="header-nav">
                <a href="/web/dictionary">Slownik</a>
                <a href="/web/receipts">Paragony</a>
                <a href="/web/search">Szukaj</a>
            </div>
        </header>

        <div id="message" class="message"></div>

        <div id="stats-bar" class="stats-bar">
            <div class="stat"><div class="stat-value" id="stat-active">-</div><div class="stat-label">Aktywne</div></div>
            <div class="stat"><div class="stat-value" id="stat-consumed">-</div><div class="stat-label">Zuzyte</div></div>
            <div class="stat"><div class="stat-value" id="stat-categories">-</div><div class="stat-label">Kategorie</div></div>
            <div class="stat"><div class="stat-value" id="stat-expiring">-</div><div class="stat-label">Wygasajace</div></div>
        </div>

        <div class="toolbar">
            <input type="text" id="search-input" placeholder="Szukaj produktu...">
            <div class="batch-actions">
                <span class="batch-count" id="selected-count">Zaznaczono: 0</span>
                <button class="btn btn-danger" id="consume-btn" onclick="consumeSelected()" disabled>Oznacz jako zuzyte</button>
            </div>
            <button class="btn btn-success" onclick="toggleAddForm()">+ Dodaj reczne</button>
            <button class="btn btn-secondary" onclick="loadData()">Odswiez</button>
        </div>

        <div id="add-form" class="add-form">
            <h3>Dodaj produkt recznie</h3>
            <div class="form-row">
                <input type="text" id="add-name" placeholder="Nazwa produktu">
                <select id="add-category"><option value="">-- Kategoria --</option></select>
                <select id="add-store"><option value="">-- Sklep --</option></select>
                <button class="btn btn-success" onclick="addManualItem()">Dodaj</button>
                <button class="btn btn-secondary" onclick="toggleAddForm()">Anuluj</button>
            </div>
        </div>

        <div id="pantry-list">
            <div class="loading">Ladowanie...</div>
        </div>
    </div>

    <script>
        const API = '';
        let allItems = [];
        let selectedIds = new Set();
        let categories = [];
        let stores = [];

        const CATEGORY_ICONS = {
            'Owoce': '&#127822;', 'Warzywa': '&#129388;', 'Nabial': '&#129371;',
            'Nabiał': '&#129371;', 'Mieso': '&#129385;', 'Mięso': '&#129385;',
            'Wedliny': '&#129361;', 'Wędliny': '&#129361;', 'Pieczywo': '&#127838;',
            'Slodycze': '&#127851;', 'Słodycze': '&#127851;', 'Przekaski': '&#127871;',
            'Przekąski': '&#127871;', 'Napoje': '&#129380;', 'Alkohol': '&#127866;',
            'Mrozonki': '&#129482;', 'Mrożonki': '&#129482;', 'Chemia': '&#129532;',
            'Kosmetyki': '&#128132;', 'Higiena': '&#129531;', 'Dom': '&#127968;',
            'Inne': '&#128230;', 'Przyprawy': '&#127798;', 'Sosy': '&#129379;',
            'Konserwy': '&#129387;', 'Makarony': '&#127837;',
        };

        document.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadCategories(), loadStores()]);
            await loadData();
            document.getElementById('search-input').addEventListener('input', debounce(filterAndRender, 300));
        });

        function debounce(fn, delay) {
            let timeout;
            return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => fn(...args), delay); };
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text; msg.className = `message ${type}`;
            setTimeout(() => msg.className = 'message', 5000);
        }

        async function loadCategories() {
            try {
                const res = await fetch(`${API}/dictionary/categories`);
                const data = await res.json();
                categories = data.map(c => c.key);
                const select = document.getElementById('add-category');
                data.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.key; opt.textContent = cat.key;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Categories load error:', e); }
        }

        async function loadStores() {
            try {
                const res = await fetch(`${API}/dictionary/stores`);
                const data = await res.json();
                stores = data.map(s => s.normalized_name);
                const select = document.getElementById('add-store');
                stores.forEach(store => {
                    const opt = document.createElement('option');
                    opt.value = store; opt.textContent = store;
                    select.appendChild(opt);
                });
            } catch (e) { console.error('Stores load error:', e); }
        }

        async function loadData() {
            const list = document.getElementById('pantry-list');
            list.innerHTML = '<div class="loading">Ladowanie...</div>';
            selectedIds.clear();
            updateSelectedCount();

            try {
                const [itemsRes, statsRes] = await Promise.all([
                    fetch(`${API}/pantry/items`),
                    fetch(`${API}/pantry/stats`),
                ]);
                allItems = await itemsRes.json();
                const stats = await statsRes.json();

                document.getElementById('stat-active').textContent = stats.active_items || 0;
                document.getElementById('stat-consumed').textContent = stats.consumed_items || 0;
                document.getElementById('stat-categories').textContent = stats.category_count || 0;
                document.getElementById('stat-expiring').textContent = stats.expiring_soon || 0;

                filterAndRender();
            } catch (e) {
                list.innerHTML = `<div class="empty-state">Blad ladowania: ${e.message}</div>`;
            }
        }

        function filterAndRender() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = allItems.filter(item => {
                if (search && !item.name.toLowerCase().includes(search)) return false;
                return true;
            });
            renderGrouped(filtered);
        }

        function renderGrouped(items) {
            const list = document.getElementById('pantry-list');

            if (!items.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#127968;</div>Spizarnia jest pusta</div>';
                return;
            }

            // Group by category
            const grouped = {};
            items.forEach(item => {
                const cat = item.category || 'Inne';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            // Sort categories by item count
            const sortedCats = Object.entries(grouped).sort((a, b) => b[1].length - a[1].length);

            list.innerHTML = sortedCats.map(([cat, catItems]) => {
                const icon = CATEGORY_ICONS[cat] || '&#128230;';
                return `
                    <div class="category-section">
                        <div class="category-header" onclick="toggleCategory('${escapeAttr(cat)}')">
                            <span class="category-name"><span class="cat-icon">${icon}</span>${escapeHtml(cat)}</span>
                            <span class="category-count">${catItems.length}</span>
                        </div>
                        <div class="category-items expanded" id="cat-${escapeAttr(cat)}">
                            ${catItems.map(item => renderItem(item)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderItem(item) {
            const daysSincePurchase = item.purchase_date
                ? Math.floor((Date.now() - new Date(item.purchase_date).getTime()) / 86400000)
                : 0;
            const isOld = daysSincePurchase > 30;
            const checked = selectedIds.has(item.id) ? 'checked' : '';
            const cls = [isOld ? 'old' : '', item.is_consumed ? 'consumed' : ''].filter(Boolean).join(' ');

            return `
                <div class="item-row ${cls}" id="item-${item.id}">
                    <input type="checkbox" class="item-checkbox" ${checked}
                           onchange="toggleSelect(${item.id}, this.checked)">
                    <span class="item-name">${escapeHtml(item.name)}</span>
                    <span class="item-store">${escapeHtml(item.store || '')}</span>
                    <span class="item-date">${item.purchase_date || ''}</span>
                    <span class="item-qty">${item.quantity !== 1 ? item.quantity + 'x' : ''}</span>
                    <div class="item-actions">
                        <button class="btn btn-danger btn-sm" onclick="consumeSingle(${item.id})" title="Zuzyj">&#10005;</button>
                    </div>
                </div>
            `;
        }

        function toggleCategory(cat) {
            const el = document.getElementById(`cat-${cat}`);
            if (el) el.classList.toggle('expanded');
        }

        function toggleSelect(id, checked) {
            if (checked) selectedIds.add(id);
            else selectedIds.delete(id);
            updateSelectedCount();
        }

        function updateSelectedCount() {
            document.getElementById('selected-count').textContent = `Zaznaczono: ${selectedIds.size}`;
            document.getElementById('consume-btn').disabled = selectedIds.size === 0;
        }

        async function consumeSelected() {
            if (!selectedIds.size) return;
            if (!confirm(`Oznaczyc ${selectedIds.size} produktow jako zuzyte?`)) return;

            try {
                const res = await fetch(`${API}/pantry/consume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: Array.from(selectedIds) }),
                });
                const data = await res.json();
                showMessage(`Oznaczono ${data.consumed} produktow jako zuzyte`, 'success');
                await loadData();
            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        async function consumeSingle(id) {
            try {
                const res = await fetch(`${API}/pantry/consume`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_ids: [id] }),
                });
                if (!res.ok) throw new Error('Failed');
                // Remove from view
                const el = document.getElementById(`item-${id}`);
                if (el) el.remove();
                allItems = allItems.filter(i => i.id !== id);
                showMessage('Produkt oznaczony jako zuzyty', 'success');
            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        function toggleAddForm() {
            document.getElementById('add-form').classList.toggle('visible');
        }

        async function addManualItem() {
            const name = document.getElementById('add-name').value.trim();
            const category = document.getElementById('add-category').value;
            const store = document.getElementById('add-store').value;

            if (!name) { showMessage('Podaj nazwe produktu', 'error'); return; }

            try {
                const res = await fetch(`${API}/pantry/items`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, category: category || null, store: store || null }),
                });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.detail || 'Unknown error');
                }
                document.getElementById('add-name').value = '';
                showMessage(`Dodano: ${name}`, 'success');
                toggleAddForm();
                await loadData();
            } catch (e) {
                showMessage(`Blad: ${e.message}`, 'error');
            }
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        function escapeAttr(str) {
            return str.replace(/[^a-zA-Z0-9\u0080-\uFFFF]/g, '_');
        }
    </script>
</body>
</html>
